<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <title>Allure Suite Report</title>

  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
    }

    h1 {
      font-size: 32px;
    }

    h2 {
      margin-top: 30px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }

    th,
    td {
      padding: 10px;
      border: 1px solid #ccc;
      text-align: left;
      vertical-align: top;
    }

    .passed {
      background: #c8f7c5;
    }

    .failed {
      background: #f7c5c5;
    }

    .skipped {
      background: #dddddd;
    }

    .test-card {
      border: 1px solid #aaa;
      padding: 15px;
      margin: 15px 0;
      border-radius: 6px;
    }

    img.screenshot {
      width: 90%;
      max-width: 900px;
      height: auto;
      margin-top: 12px;
      border: 1px solid #666;
      display: block;
    }

    .error {
      color: #b00020;
      font-weight: bold;
      white-space: pre-wrap;
    }

    .trace {
      font-size: 12px;
      background: #f5f5f5;
      padding: 10px;
      border-left: 4px solid #f44336;
      white-space: pre-wrap;
      margin-top: 8px;
    }

    .page {
      page-break-before: always;
    }

    .page:first-of-type {
      page-break-before: avoid;
    }
  </style>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script>
    window.REPORT_DATA = __ALLURE_DATA__;
  </script>
</head>

<body>

  <h1>Allure Execution PDF</h1>

  <!-- ================= PAGE 1 ================= -->
  <div class="page">
    <h2>Summary</h2>
    <table>
      <tr>
        <th>Total</th>
        <th>Passed</th>
        <th>Failed</th>
        <th>Skipped</th>
        <th>Retries</th>
      </tr>
      <tr>
        <td id="total"></td>
        <td id="passed" class="passed"></td>
        <td id="failed" class="failed"></td>
        <td id="skipped" class="skipped"></td>
        <td id="retries"></td>
      </tr>
    </table>
    <h2>Test List</h2>
    <table id="tests-table">
      <thead>
        <tr>
          <th>Test Name</th>
          <th>Status</th>
          <th>Duration (ms)</th>
          <th>Retries</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- ================= PAGE 2 ================= -->
  <div class="page">
    <h2>Status Distribution</h2>
    <canvas id="pieChart" width="600" height="600"></canvas>
  </div>

  <!-- ================= PAGE 3 ================= -->
  <div class="page">
    <h2>Duration per Test</h2>
    <canvas id="durationChart" height="300"></canvas>
  </div>

  <!-- ================= PAGE 4+ ================= -->
  <div class="page">
    <h2>Failed Logs</h2>
    <div id="test-list"></div>
  </div>

  <script>
    /* ===== WHITE BACKGROUND FIX ===== */
    const whiteBackgroundPlugin = {
      id: 'whiteBackground',
      beforeDraw(chart) {
        const ctx = chart.ctx;
        ctx.save();
        ctx.globalCompositeOperation = 'destination-over';
        ctx.fillStyle = '#ffffff';
        ctx.fillRect(0, 0, chart.width, chart.height);
        ctx.restore();
      }
    };

    /* ===== LABELS INSIDE PIE ===== */
    const pieLabelPlugin = {
      id: 'pieLabelPlugin',
      afterDraw(chart) {
        const ctx = chart.ctx;
        const dataset = chart.data.datasets[0];
        const meta = chart.getDatasetMeta(0);

        ctx.save();
        ctx.font = "bold 16px Arial";
        ctx.fillStyle = "#ffffff";
        ctx.textAlign = "center";
        ctx.textBaseline = "middle";

        meta.data.forEach((arc, index) => {
          const value = dataset.data[index];
          if (!value) return;
          const pos = arc.tooltipPosition();
          ctx.fillText(`${chart.data.labels[index]}: ${value}`, pos.x, pos.y);
        });

        ctx.restore();
      }
    };

    document.addEventListener("DOMContentLoaded", () => {
      const report = window.REPORT_DATA;

      total.innerText = report.stats.total;
      passed.innerText = report.stats.passed;
      failed.innerText = report.stats.failed;
      skipped.innerText = report.stats.skipped;
      retries.innerText = report.stats.retries;

      /* ===== POPULATE TESTS TABLE ===== */
      const testsTbody = document.querySelector("#tests-table tbody");

      report.tests.forEach(test => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
    <td>${test.name}</td>
    <td class="${test.status}">${test.status}</td>
    <td>${test.duration}</td>
    <td>${test.retries}</td>
  `;
        testsTbody.appendChild(tr);
      });


      /* ===== PIE CHART ===== */
      new Chart(pieChart, {
        type: "pie",
        plugins: [whiteBackgroundPlugin, pieLabelPlugin],
        data: {
          labels: ["Passed", "Failed", "Skipped"],
          datasets: [{
            data: [
              parseInt(report.stats.passed),
              parseInt(report.stats.failed),
              parseInt(report.stats.skipped)
            ],
            backgroundColor: ["#4CAF50", "#F44336", "#9E9E9E"],
            borderWidth: 0,
            radius: "92%"
          }]
        },
        options: {
          responsive: false,
          animation: false,
          plugins: {
            legend: {
              position: "right",
              labels: {
                font: { size: 14 }
              }
            }
          }
        }
      });

      /* ===== DURATION CHART (UNCHANGED) ===== */
      new Chart(durationChart, {
        plugins: [whiteBackgroundPlugin],
        type: "bar",
        data: {
          labels: report.tests.map(t => t.name),
          datasets: [{
            label: "Duration (ms)",
            data: report.tests.map(t => t.duration),
            backgroundColor: "#2196F3"
          }]
        }
      });

      /* ===== FAILED LOGS (FULL DETAILS PRESERVED) ===== */
      const list = document.getElementById("test-list");

      report.tests.filter(t => t.status === "failed").forEach(test => {
        const div = document.createElement("div");
        div.className = "test-card failed";

        div.innerHTML = `
      <h3>${test.name}</h3>
      <p><strong>Suite:</strong> ${test.suiteName}</p>
      <p class="error">Failure Reason:<br>${test.errorMessage || "N/A"}</p>
      ${test.errorTrace ? `<div class="trace">${test.errorTrace}</div>` : ""}
      <p><strong>Retries:</strong> ${test.retries}</p>
      <p><strong>Duration:</strong> ${test.duration} ms</p>

      <h4>Screenshot</h4>
      ${test.attachments.length
            ? test.attachments.map(a =>
              `<img class="screenshot" src="../${a.source}">`
            ).join("")
            : "<p>No screenshot available.</p>"
          }
    `;

        list.appendChild(div);
      });
    });
  </script>

</body>

</html>